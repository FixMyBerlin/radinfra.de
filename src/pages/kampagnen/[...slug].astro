---
export const prerender = true
//
import { maprouletteChallengeUrl } from '@components/Link/maprouletteChallengeUrl'
import MegaButton from '@components/Link/MegaButton.astro'
import CampaignCards from '@components/page_kampagne/CampaignCards.astro'
import { Markdown } from '@components/text/Markdown'
import PageHeadline from '@components/text/PageHeadline.astro'
import ProseSection from '@components/text/ProseSection.astro'
import LayoutArticlePageAstro from '@layouts/LayoutArticlePageAstro.astro'
import { type CollectionEntry, getCollection } from 'astro:content'

export async function getStaticPaths() {
  const campaigns = await getCollection('campaigns')
  return campaigns.map((campaign) => ({
    params: { slug: campaign.id.replace('/index', '') },
    props: campaign,
  }))
}
type Props = CollectionEntry<'campaigns'>

const page = Astro.props
// NOTE:
//   We cannot use the Keystatic<>Astro content integration
//   https://github.com/Thinkmill/keystatic/discussions/1318
//   ~`const { Content } = await render(page)`~

const relatedCampaigns = await getCollection('campaigns', ({ data }) => {
  return data.category === page.data.category
})

const maprouletteUrl = maprouletteChallengeUrl(page.data.maprouletteChallenge.id)
---

<LayoutArticlePageAstro
  title={page.data.name}
  {...page.data}
  noindex={!maprouletteUrl || !page.data.maprouletteChallenge.enabled}
>
  <PageHeadline category="Kampagnen" headline={page.data.name} intro={page.data.description} />

  <Markdown markdown={`**Aufgabe:** ${page.data.task}`} />

  <ProseSection>
    <h2>Mitmachen</h2>
    <p class="!mb-0">Es gibt zwei Einstiege zu den Aufgaben:</p>

    <div class="grid gap-4 sm:grid-cols-2">
      <article>
        <h3 class="sr-only">Einstieg über MapRoulette</h3>
        {
          maprouletteUrl ? (
            <MegaButton
              href={maprouletteUrl}
              iconKey="maproulette"
              label="MapRoulette"
              subline="Fokussiert Aufgabe für Aufgabe bearbeiten."
              className="mt-6"
            />
          ) : (
            <p>
              <small>Diese Kampagne ist noch nicht aktiv, daher gibt es noch keine Links.</small>
            </p>
          )
        }
      </article>
      <article>
        <h3 class="sr-only">Einstieg über Karte</h3>
        {
          page.data.mapUrl ? (
            <MegaButton
              href={page.data.mapUrl}
              iconKey="map"
              label="Karte"
              subline="Aufgaben aus dem Kontext heraus finden."
              className="mt-6"
            />
          ) : null
        }
      </article>
    </div>
  </ProseSection>

  <div class="mt-12 border-y border-gray-100">
    <dl class="my-0 divide-y divide-gray-100">
      <!-- <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
        <dt class="m-0 text-sm font-medium leading-6 text-gray-900">Name der Kampagne</dt>
        <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-2 sm:mt-0">
          {page.data.maprouletteChallenge.name}
        </dd>
      </div> -->
      <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
        <dt class="m-0 text-sm font-medium leading-6 text-gray-900">Quelle</dt>
        <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-2 sm:mt-0">
          <a href={page.data.maprouletteChallenge.remoteGeoJson} target="_blank">GeoJson</a>
          {
            page.data.maprouletteChallenge.remoteGeoJson.includes('radverkehrsatlas') ? (
              <div>
                Diese Kampagne basiert auf Prozessierung im Projekt{' '}
                <a target="_blank" href="https://radverkehrsatlas.de">
                  radverkehrsatlas.de
                </a>
                .{' '}
                <a
                  target="_blank"
                  href="https://github.com/FixMyBerlin/atlas-app/blob/develop/processing/topics/roads_bikelanes/bikelanes/BikelaneTodos.lua"
                >
                  Der Quellcode ist auf Github
                </a>
                .
              </div>
            ) : null
          }
        </dd>
      </div>
      <div class="px-4 py-6 sm:grid sm:grid-cols-3 sm:gap-4 sm:px-0">
        <dt class="m-0 text-sm font-medium leading-6 text-gray-900">
          <span style="color:#448ee4">OSM</span>Cha
        </dt>
        <dd class="mt-1 text-sm leading-6 text-gray-700 sm:col-span-2 sm:mt-0">
          <a
            href={`https://osmcha.org/?filters={"date__gte":[{"label":"2024-09-01","value":"2024-09-01"}],"source":[{"label":"${page.data.maprouletteChallenge.checkinSource}","value":"${page.data.maprouletteChallenge.checkinSource}"}]}`}
            target="_blank"
          >
            Changesets dieser Kampagne mit der Quelle
            <code>{page.data.maprouletteChallenge.checkinSource}</code>
            in OSMCha öffnen
          </a>
        </dd>
      </div>
    </dl>
  </div>

  {
    relatedCampaigns.length > 0 && (
      <footer>
        <CampaignCards
          headlineTemplate="Weitere Kampagnen zu »CATEGORY«"
          campaigns={relatedCampaigns}
          showEmptyCategories={false}
        />
      </footer>
    )
  }
</LayoutArticlePageAstro>
